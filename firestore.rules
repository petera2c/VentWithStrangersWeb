rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    //return exists(/databases/$(database)/documents/block_check/$(userID+"|||"+userID2));

    match /comments/{commentID} {
      allow read: if true;
      allow write: if request.auth.uid == request.resource.data.userID;
      allow update: if request.auth.uid == resource.data.userID;
      allow delete: if request.auth.uid == resource.data.userID || get(/databases/$(database)/documents/vents/$(resource.data.ventID)).data.userID == request.auth.uid;
    }

    match /conversations/{conversationID} {
      allow read: if request.auth.uid in resource.data.members;
      allow write, delete: if request.auth.uid in request.resource.data.members;
      allow update: if request.auth.uid in resource.data.members;
    }

    match /conversation_extra_data/{conversationID} {
      match /messages/{messagesID} {
        allow read: if true;
        allow write: if request.auth.uid == request.resource.data.userID;
        allow update: if request.auth.uid == resource.data.userID
          && request.auth.uid == request.resource.data.userID;
        allow delete: if request.auth.uid == resource.data.userID;
      }
    }

    match /notifications/{notificationID} {
      allow read: if request.auth.uid == resource.data.userID;
      allow write, delete: if request.auth.uid == request.resource.data.userID;
      allow update: if request.auth.uid == request.resource.data.userID
        && request.resource.data.userID == resource.data.userID;
    }

    match /vents/{ventID} {
      allow read: if true;
      allow write: if request.auth.uid == request.resource.data.userID && get(/databases/$(database)/documents/user_day_limit_vents/$(request.auth.uid)).data.vent_counter != 2;
      allow update: if request.auth.uid == request.resource.data.userID
        && request.resource.data.userID == resource.data.userID;
      allow delete: if request.auth.uid == resource.data.userID;


      match /trending_score {
        allow read: if true;
        allow write, update, delete: if false;
      }
    }

    match /users/{userID} {
      allow read, write, update, delete: if request.auth.uid == userID;
    }

    match /users_display_name/{userID} {
      allow read: if true;
      allow write, update, delete: if request.auth.uid == userID;


      match /bad_karma {
        allow read: if true;
        allow write, update, delete: if false;
      }
      match /good_karma {
        allow read: if true;
        allow write, update, delete: if false;
      }
    }

    match /users_info/{userID} {
      allow read: if true;
      allow write, update, delete: if request.auth.uid == userID;
    }

    match /user_day_limit_vents/{userID} {
      allow read: if request.auth.uid == userID;
      allow write, update, delete: if false;
    }

    match /unread_conversations_count/{userID} {
      allow read, write, update, delete: if request.auth.uid == userID;
    }

    match /user_expo_tokens/{userID} {
      allow read, write, update, delete: if request.auth.uid == userID;
    }

    match /vent_likes/{ventIDUserID} {
      allow read, write, update, delete: if request.auth.uid == ventIDUserID.split('\\|\\|\\|')[1];
    }

    match /comment_likes/{commentIDUserID} {
      allow read, write, update, delete: if request.auth.uid == commentIDUserID.split('\\|\\|\\|')[1];
    }

    match /vent_reports/{ventIDUserID} {
      allow read, write, update, delete: if request.auth.uid == ventIDUserID.split('\\|\\|\\|')[1];
    }

    match /comment_reports/{commentIDUserID} {
      allow read, write, update, delete: if request.auth.uid == commentIDUserID.split('\\|\\|\\|')[1];
    }

    match /admin_notifications/{adminNotificationID} {
      allow read, delete: if true;
      allow write, update: if false;
    }

    match /block_check/{userIDuserID2} {
      allow read: if request.auth.uid == userIDuserID2.split('\\|\\|\\|')[0] || request.auth.uid == userIDuserID2.split('\\|\\|\\|')[1];
      allow write: if request.resource.data.keys().hasOnly([request.auth.uid]);
      allow update: if request.resource.data.diff(resource.data).affectedKeys().hasOnly([request.auth.uid]);
      allow delete: if false;
    }
  }
}
